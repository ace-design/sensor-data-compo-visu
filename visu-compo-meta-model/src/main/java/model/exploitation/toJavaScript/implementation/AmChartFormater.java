package model.exploitation.toJavaScript.implementation;

import model.exploitation.toJavaScript.metaclasse.ElementInstance;
import model.exploitation.toJavaScript.metaclasse.VisualizationInstance;
import org.json.JSONWriter;
import model.exploitation.toJavaScript.interfaces.DataTargetFormater;

import java.io.StringWriter;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.*;

/**
 * Created by Ivan Logre on 01/07/2014.
 */
public class AmChartFormater implements DataTargetFormater {


    @Override
    public String convertData2LibraryFormat(VisualizationInstance vi) {
        StringWriter dataToPrint = new StringWriter();
        JSONWriter rootDest = new JSONWriter(dataToPrint);
        rootDest.array();

        //TODO : Composite part

        // Atomic part (//TODO will be a loop)
        while(!vi.isEmpty()){
            ElementInstance first = vi.getFirstIndex();
            rootDest.object();
            rootDest.key(first.father.getName());
            rootDest.value(first.getValue().toString());
            for(ElementInstance ei : first.getValues()){
                rootDest.key(ei.father.getName());
                rootDest.value(ei.getValue());
            }
            rootDest.endObject();
            first.getResourceInstance().removeKey(first);
        }
        rootDest.endArray();
        return dataToPrint.toString();
    }

    @Override
    public String convertTimedData2LibraryFormat(VisualizationInstance vi) {

        StringWriter dataToPrint = new StringWriter();
        JSONWriter rootDest = new JSONWriter(dataToPrint);
        rootDest.array();
        DateFormat df = new SimpleDateFormat("yy-MM-dd HH:mm:ss", Locale.ENGLISH);

        while(!vi.isEmpty()){
            ElementInstance first = vi.getFirstIndex();
            rootDest.object();
            // index = ti
            rootDest.key(first.father.getName());
            Date date = new Date((Long)first.getValue()*1000);

            rootDest.value(df.format(date));
            for(ElementInstance ei : first.getValues()){
                rootDest.key(ei.father.getName()+ei.resourceInstance.father.getName());
                rootDest.value(ei.getValue());
            }
            rootDest.endObject();
            first.getResourceInstance().removeKey(first);
        }
        rootDest.endArray();
        return dataToPrint.toString();
    }
}
