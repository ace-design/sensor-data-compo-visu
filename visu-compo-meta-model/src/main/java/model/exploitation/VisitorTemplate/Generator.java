package model.exploitation.VisitorTemplate;

import exception.UnhandledDataFormatException;
import exception.VisitorException;
import metaclasses.Dashboard;
import metaclasses.resource.AtomicResource;
import metaclasses.resource.CompositeResource;
import metaclasses.resource.Resource;
import metaclasses.Visualization;
import org.stringtemplate.v4.ST;
import org.stringtemplate.v4.STGroup;
import org.stringtemplate.v4.STGroupDir;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;

/**
 * Created by ivan on 17/07/2014.
 */
public class Generator implements IGenerativeVisitor{

    // We grab the group of string pattern
    private static final String STpath = Generator.class.getClassLoader().getResource("stringtemplates/").getPath();

    static STGroup group;
    static STGroup importsgroup;
    static STGroup amgroup;
    static STGroup highgroup;
    static STGroup smartcampusgroup;

    static HashMap<String, Object> symbolTable;
    static ST myPage;
    protected Generator(){};

    public String myPageToString() {
        return myPage.render();
    }

    public Generator(String pathToGenerate){
        this.symbolTable = new HashMap<>();
        group = new STGroupDir(STpath+"common",'$', '$');
        importsgroup = new STGroupDir(STpath+"imports",'$', '$');
        amgroup = new STGroupDir(STpath+"amchart",'$', '$');
        highgroup = new STGroupDir(STpath+"highchart",'$', '$');
        smartcampusgroup = new STGroupDir(STpath+"smartcampus",'$', '$');
        this.newSymbol("pathToGenerate",pathToGenerate);
    }

    @Override
    public void visit(Dashboard dashboard) throws VisitorException {
        //create the html page
        this.myPage = group.getInstanceOf("html");

        //organize the needed imports
        List<String> knownLib = new ArrayList(Arrays.asList("amchart", "highchart", "smartcampus"));
        for(String lib : knownLib)
            if(isNeeded(dashboard, lib))
                myPage.add("imports",importsgroup.getInstanceOf("import_"+lib));


        //propagation
        for(Visualization visualization : dashboard.getVisualizationList())
            visualization.accept(this);


    }

    @Override
    public void visit(Visualization visualization) throws VisitorException {
        String chartName = visualization.getName();

        Generator genLibrarySpecific;
        switch (visualization.getLibraryName()) {
            case "AmChart":
                genLibrarySpecific = new Generator2AmChart();
                break;
            case "HighChart":
                genLibrarySpecific = new Generator2HighChart();
                break;
            case "SmartCampus":
                genLibrarySpecific = new Generator2SmartCampus();
                break;
            default:
                throw new UnhandledDataFormatException();
        }
        visualization.accept(genLibrarySpecific);

        ST st_data = (ST) symbolTable.get("data_"+visualization.getName());
        myPage.add("data",st_data);

        ST st_chart = (ST) symbolTable.get(visualization.getName());
        myPage.add("chartsscript", st_chart);

        //Chart Body
        ST st_chartBody = group.getInstanceOf("chartbody");
        st_chartBody.add("chartname", chartName);
        st_chartBody.add("widthpercent", 100 / visualization.getDashboard().getVisualizationList().size());
        myPage.add("chartsbody", st_chartBody);
    }

    @Override
    public void visit(AtomicResource resource) throws VisitorException {

    }

    @Override
    public void visit(CompositeResource resource) throws VisitorException {

    }


    ///////////////////// Private methods /////////////////////

    private void newSymbol(String key, Object o) {
        if (!this.symbolTable.containsKey(key))
            this.symbolTable.put(key, o);
    }

    private static boolean isNeeded(Dashboard dashboard, String library) {
        boolean isNeeded = false;
        for (Visualization v : dashboard.getVisualizationList()) {
            if (v.getLibraryName().equalsIgnoreCase(library)) {
                isNeeded = true;
                break;
            }
        }
        return isNeeded;
    }
}
